// Database of all questions, grouped by round
const questionsDB = {
  "round1": [
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (1).png",
      "answerImage": "quiz_Answer_images_round1/A (1).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (2).png",
      "answerImage": "quiz_Answer_images_round1/A (2).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (3).png",
      "answerImage": "quiz_Answer_images_round1/A (3).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (4).png",
      "answerImage": "quiz_Answer_images_round1/A (4).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (5).png",
      "answerImage": "quiz_Answer_images_round1/A (5).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (6).png",
      "answerImage": "quiz_Answer_images_round1/A (6).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (7).png",
      "answerImage": "quiz_Answer_images_round1/A (7).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (8).png",
      "answerImage": "quiz_Answer_images_round1/A (8).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (9).png",
      "answerImage": "quiz_Answer_images_round1/A (9).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (10).png",
      "answerImage": "quiz_Answer_images_round1/A (10).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (11).png",
      "answerImage": "quiz_Answer_images_round1/A (11).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round1/q (12).png",
      "answerImage": "quiz_Answer_images_round1/A (12).png"
    }
  ],
  "round2": [
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (1).png",
      "answerImage": "quiz_answer_images_round2/A2 (1).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (2).png",
      "answerImage": "quiz_answer_images_round2/A2 (2).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (3).png",
      "answerImage": "quiz_answer_images_round2/A2 (3).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (4).png",
      "answerImage": "quiz_answer_images_round2/A2 (4).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (5).png",
      "answerImage": "quiz_answer_images_round2/A2 (5).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (6).png",
      "answerImage": "quiz_answer_images_round2/A2 (6).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (7).png",
      "answerImage": "quiz_answer_images_round2/A2 (7).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (8).png",
      "answerImage": "quiz_answer_images_round2/A2 (8).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (9).png",
      "answerImage": "quiz_answer_images_round2/A2 (9).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (10).png",
      "answerImage": "quiz_answer_images_round2/A2 (10).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (11).png",
      "answerImage": "quiz_answer_images_round2/A2 (11).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round2/Q2 (12).png",
      "answerImage": "quiz_answer_images_round2/A2 (12).png"
    }
  ],
  "round3": [
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (1).png",
      "answerImage": "quiz_answer_images_round3/A3 (1).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (2).png",
      "answerImage": "quiz_answer_images_round3/A3 (2).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (3).png",
      "answerImage": "quiz_answer_images_round3/A3 (3).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (4).png",
      "answerImage": "quiz_answer_images_round3/A3 (4).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (5).png",
      "answerImage": "quiz_answer_images_round3/A3 (5).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (6).png",
      "answerImage": "quiz_answer_images_round3/A3 (6).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (7).png",
      "answerImage": "quiz_answer_images_round3/A3 (7).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (8).png",
      "answerImage": "quiz_answer_images_round3/A3 (8).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (9).png",
      "answerImage": "quiz_answer_images_round3/A3 (9).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (10).png",
      "answerImage": "quiz_answer_images_round3/A3 (10).png"
    },
    {
      "type": "image-only",
      "image": "quiz_question_images_round3/Q3 (11).png",
      "answerImage": "quiz_answer_images_round3/A3 (11).png"
    }
  ]
};



// Helper to get random questions for a round
function getRandomQuestions(round, count) {
  const arr = [...questionsDB[round]];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.slice(0, count);
}

    let currentRound = 1; // 1 = round1, 2 = round2
    let quizData = getRandomQuestions('round1', 12);
    let currentQuestion = 0;
    let timeLeft = 20;
    let timer = null;

    const registrationContainer = document.getElementById("registration-container");
    const introContainer = document.getElementById("intro-container");
    const explanation1Container = document.getElementById("explanation1-container");
    const rulesContainer = document.getElementById("rules-container");
    const explanation2Container = document.getElementById("explanation2-container");
    const explanation3Container = document.getElementById("explanation3-container");
    const quizContainer = document.getElementById("quiz-container");
    const endContainer = document.getElementById("end-container");
    const questionEl = document.getElementById("question");
    const optionsEl = document.getElementById("options");
    const timeEl = document.getElementById("time");
    const rings = document.querySelectorAll(".ring");
    const totalTime = 20;
    const scoresEl = document.getElementById("scores");
    const leaderboardEl = document.getElementById("leaderboard");
    const teamNameInput = document.getElementById("team-name-input");
    const registeredTeamsList = document.getElementById("registered-teams-list");
    const roundTransitionBtn = document.getElementById("round-transition-btn");
    const rules2Container = document.getElementById("rules2-container");
    const startRound2Btn = document.getElementById("start-round2-btn");
    const rules3Container = document.getElementById("rules3-container");
    const startRound3Btn = document.getElementById("start-round3-btn");
    const roundToggleBtn = document.getElementById("round-toggle-btn");

    let teams = [];

    function registerTeam() {
        const teamName = teamNameInput.value.trim();
        if (teamName) {
            teams.push({ name: teamName, score: 0 });
            teamNameInput.value = '';
            updateRegisteredTeamsList();
            saveAndRefreshScores();
        }
    }

    function updateRegisteredTeamsList() {
        registeredTeamsList.innerHTML = '';
        teams.forEach((team, index) => {
            const teamItem = document.createElement('div');
            teamItem.className = 'registered-team-item';

            const teamNameSpan = document.createElement('span');
            teamNameSpan.textContent = team.name;

            const buttonsWrapper = document.createElement('div');
            buttonsWrapper.className = 'team-buttons';

            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.onclick = () => editTeamName(index);

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.onclick = () => deleteTeam(index);

            buttonsWrapper.appendChild(editButton);
            buttonsWrapper.appendChild(deleteButton);

            teamItem.appendChild(teamNameSpan);
            teamItem.appendChild(buttonsWrapper);
            registeredTeamsList.appendChild(teamItem);
        });
    }

    function editTeamName(index) {
        const newName = prompt("Enter new name for " + teams[index].name, teams[index].name);
        if (newName && newName.trim() !== "") {
            teams[index].name = newName.trim();
            updateRegisteredTeamsList();
            saveAndRefreshScores();
        }
    }

    function deleteTeam(index) {
        if (confirm("Are you sure you want to delete " + teams[index].name + "?")) {
            teams.splice(index, 1);
            updateRegisteredTeamsList();
            saveAndRefreshScores();
        }
    }

    function showIntro() {
        if (teams.length === 0) {
            alert("Please register at least one team.");
            return;
        }
        registrationContainer.classList.add("hidden");
        introContainer.classList.remove("hidden");
        initializeScores();
    }

    function initializeScores() {
        const storedScores = localStorage.getItem('quizScores');
        if (storedScores) {
            const parsedTeams = JSON.parse(storedScores);
            if (parsedTeams.length > 0) {
                teams = parsedTeams;
            }
        }
        setupScores();
        updateLeaderboard();
    }

    function setupScores() {
        scoresEl.innerHTML = '';
        teams.forEach((team, index) => {
            const teamDiv = document.createElement('div');
            teamDiv.className = 'team';
            teamDiv.innerHTML = `
                <span class="team-name">${team.name}: ${team.score}</span>
                <div class="score-buttons">
                    <button onclick="incrementScore(${index})">+10</button>
                    <button onclick="decrementScore(${index})">-5</button>
                </div>
            `;
            scoresEl.appendChild(teamDiv);
        });
    }

    function incrementScore(teamIndex) {
        teams[teamIndex].score += 10;
        saveAndRefreshScores();
    }

    function decrementScore(teamIndex) {
        teams[teamIndex].score -= 5;
        saveAndRefreshScores();
    }

    function saveAndRefreshScores() {
        localStorage.setItem('quizScores', JSON.stringify(teams));
        setupScores();
        updateLeaderboard();
    }

    function loadTeamsFromStorage() {
        const storedTeams = localStorage.getItem('quizScores');
        if (storedTeams) {
            teams = JSON.parse(storedTeams);
            updateRegisteredTeamsList();
            setupScores();
            updateLeaderboard();
        }
    }

    function updateLeaderboard() {
        leaderboardEl.innerHTML = '';
        const sortedTeams = [...teams].sort((a, b) => b.score - a.score);

        sortedTeams.forEach((team, index) => {
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            item.innerHTML = `
                <div class="rank">${index + 1}</div>
                <div class="player-info">
                    <div class="player-name">${team.name}</div>
                    <div class="player-score">${team.score}</div>
                </div>
            `;
            leaderboardEl.appendChild(item);
        });
    }


    function showRules() {
        introContainer.classList.add("hidden");
        explanation1Container.classList.remove("hidden");
    }

    function showRound1Rules() {
        explanation1Container.classList.add("hidden");
        rulesContainer.classList.remove("hidden");
    }

    function showRound2Rules() {
        explanation2Container.classList.add("hidden");
        rulesContainer.classList.add("hidden");
        rules2Container.classList.remove("hidden");
    }

    function showRound3Rules() {
        explanation3Container.classList.add("hidden");
        rulesContainer.classList.add("hidden");
        rules2Container.classList.add("hidden");
        rules3Container.classList.remove("hidden");
    }


    function startQuiz() {
        rulesContainer.classList.add("hidden");
        quizContainer.classList.remove("hidden");
        loadQuestion();
    }


    function animateQuizElements() {
      // Animate question
      questionEl.classList.remove('fade-up');
      void questionEl.offsetWidth; // trigger reflow
      questionEl.classList.add('fade-up');
      // Animate options
      const optionDivs = optionsEl.querySelectorAll('.option');
      optionDivs.forEach((div, i) => {
        div.classList.remove('fade-up');
        void div.offsetWidth;
        div.style.animationDelay = (0.1 + i * 0.1) + 's';
        div.classList.add('fade-up');
      });
    }

    // Load question
    function loadQuestion() {
      if (currentQuestion >= quizData.length) {
        quizContainer.classList.add("hidden");
        if (currentRound === 1) {
          endContainer.classList.remove("hidden");
          endContainer.querySelector('h1').textContent = 'ROUND 1 FINISH!!';
          if (roundTransitionBtn) {
            roundTransitionBtn.style.display = 'inline-block';
            roundTransitionBtn.textContent = 'Enter Round 2';
            roundTransitionBtn.onclick = () => startRound2();
          }
        } else if (currentRound === 2) {
          endContainer.classList.remove("hidden");
          endContainer.querySelector('h1').textContent = 'ROUND 2 FINISH!!';
          if (roundTransitionBtn) {
            roundTransitionBtn.style.display = 'inline-block';
            roundTransitionBtn.textContent = 'Enter Round 3';
            roundTransitionBtn.onclick = () => startRound3();
          }
        } else {
          endContainer.classList.remove("hidden");
          endContainer.querySelector('h1').textContent = 'QUIZ FINISH!!';
          if (roundTransitionBtn) {
            roundTransitionBtn.style.display = 'none';
            roundTransitionBtn.onclick = null;
          }
          // Only show final results for round 3
          if (currentRound === 3) {
            populateFinalResults();
            document.querySelector('.final-results-container').style.display = 'flex';
          } else {
            document.querySelector('.final-results-container').style.display = 'none';
          }
        }
        clearInterval(timer);
        return;
      }
      const q = quizData[currentQuestion];
      questionEl.innerHTML = '';
      optionsEl.innerHTML = '';

      // Style and render by type
      if (q.type === "image-only") {
        // Show only the question image, no question text
        const img = document.createElement("img");
        img.src = q.image;
        img.className = "quiz-image";
        img.style.display = 'block'; // Ensure it's visible
        optionsEl.appendChild(img);
        questionEl.innerHTML = ''; // No question text
        questionEl.className = 'question image-only-question';
      } else if (q.type === "mcq") {
        questionEl.innerText = q.question;
        questionEl.className = 'question mcq-question';
        q.options.forEach((opt, index) => {
          const div = document.createElement("div");
          div.classList.add("option", "mcq-option");
          div.innerText = opt;
          optionsEl.appendChild(div);
        });
      } else if (q.type === "text") {
        questionEl.innerText = q.question;
        questionEl.className = 'question text-question';
        // Render hidden answer element to reveal later
        const ans = document.createElement('div');
        ans.className = 'text-answer hidden';
        ans.textContent = 'Answer: ' + q.answer;
        optionsEl.appendChild(ans);
      } else if (q.type === "image-mcq" || q.type === "image-text") {
        // Show image
        const img = document.createElement("img");
        img.src = q.image;
        img.className = "quiz-image";
        optionsEl.appendChild(img);
        questionEl.innerText = q.question;
        questionEl.className = 'question image-question';
        if (q.type === "image-mcq") {
          q.options.forEach((opt, index) => {
            const div = document.createElement("div");
            div.classList.add("option", "image-mcq-option");
            div.innerText = opt;
            optionsEl.appendChild(div);
          });
        } else {
          // Render hidden answer element for image-text
          const ans = document.createElement('div');
          ans.className = 'text-answer hidden';
          ans.textContent = 'Answer: ' + q.answer;
          optionsEl.appendChild(ans);
        }
      } else if (q.type === "true-false") {
        questionEl.innerText = q.question;
        questionEl.className = 'question true-false-question';
        ["True", "False"].forEach(val => {
          const div = document.createElement("div");
          div.classList.add("option", "true-false-option");
          div.innerText = val;
          optionsEl.appendChild(div);
        });
      }
      animateQuizElements();
      
      // Update Previous button visibility
      updatePreviousButtonVisibility();
    }

    // Show Answer
    function showAnswer() {
      clearInterval(timer);
      const q = quizData[currentQuestion];
      // If TIME UP overlay is present, remove it first
      const timeupOverlay = optionsEl.querySelector('.timeup-image');
      if (timeupOverlay) {
        timeupOverlay.remove();
      }
      if (q.type === "image-only") {
        // Hide the question image and show the answer image in its place
        const questionImg = optionsEl.querySelector('.quiz-image');
        if (questionImg) {
          questionImg.style.display = 'none';
        }
        // Prevent duplicate answer images
        const existingAnswerImg = optionsEl.querySelector('.answer-image');
        if (existingAnswerImg) {
          return;
        }
        
        // Show the answer image
        const answerImg = document.createElement("img");
        answerImg.src = q.answerImage;
        answerImg.className = "quiz-image answer-image";
        answerImg.style.marginTop = "20px";
        optionsEl.appendChild(answerImg);
      } else if (q.type === "mcq" || q.type === "image-mcq" || q.type === "true-false") {
        const opts = document.querySelectorAll(".option");
        opts.forEach(opt => {
          if (opt.innerText !== q.answer) {
            opt.classList.add("hidden");
          } else {
            opt.classList.remove("fade-left", "fade-right");
            opt.classList.add("show-answer");
          }
        });
      } else if (q.type === "text" || q.type === "image-text") {
        const ans = optionsEl.querySelector('.text-answer');
        if (ans) {
          ans.classList.remove('hidden');
          ans.classList.add('show-answer');
        }
      }
    }

    // Previous Question
    function previousQuestion() {
      if (currentQuestion > 0) {
        currentQuestion--;
        loadQuestion();
        
        // Reset timer display without starting it
        timeLeft = 15;
        timeEl.classList.remove('time-up');
        timeEl.innerText = timeLeft;
        timeEl.style.color = `rgb(${gold[0]}, ${gold[1]}, ${gold[2]})`;
        rings.forEach(r => {
          r.style.opacity = 1;
          r.style.borderColor = `rgb(${gold[0]}, ${gold[1]}, ${gold[2]})`;
        });
        clearInterval(timer);
        
        // Animate after loading
        animateQuizElements();
        
        // Update Previous button visibility
        updatePreviousButtonVisibility();
      }
    }

    // Update Previous button visibility
    function updatePreviousButtonVisibility() {
      const prevBtn = document.getElementById('prev-btn');
      if (prevBtn) {
        if (currentQuestion === 0) {
          prevBtn.style.display = 'none';
        } else {
          prevBtn.style.display = 'inline-block';
        }
      }
    }

    // Next Question
    function nextQuestion() {
      currentQuestion++;
      if (currentQuestion >= quizData.length) {
          quizContainer.classList.add("hidden");
          if (currentRound === 1) {
            endContainer.classList.remove("hidden");
            endContainer.querySelector('h1').textContent = 'ROUND 1 FINISH!!';
            if (roundTransitionBtn) {
              roundTransitionBtn.style.display = 'inline-block';
              roundTransitionBtn.textContent = 'Enter Round 2';
              roundTransitionBtn.onclick = () => startRound2();
            }
          } else if (currentRound === 2) {
            endContainer.classList.remove("hidden");
            endContainer.querySelector('h1').textContent = 'ROUND 2 FINISH!!';
            if (roundTransitionBtn) {
              roundTransitionBtn.style.display = 'inline-block';
              roundTransitionBtn.textContent = 'Enter Round 3';
              roundTransitionBtn.onclick = () => startRound3();
            }
          } else {
            endContainer.classList.remove("hidden");
            endContainer.querySelector('h1').textContent = 'QUIZ FINISH!!';
            if (roundTransitionBtn) {
              roundTransitionBtn.style.display = 'none';
              roundTransitionBtn.onclick = null;
            }
            // Only show final results for round 3
            if (currentRound === 3) {
              populateFinalResults();
              document.querySelector('.final-results-container').style.display = 'flex';
            } else {
              document.querySelector('.final-results-container').style.display = 'none';
            }
          }
          clearInterval(timer);
          return;
      }
      loadQuestion();
      
      // Reset timer display without starting it
      timeLeft = 15;
      timeEl.classList.remove('time-up');
      timeEl.innerText = timeLeft;
      timeEl.style.color = `rgb(${gold[0]}, ${gold[1]}, ${gold[2]})`;
      rings.forEach(r => {
        r.style.opacity = 1;
        r.style.borderColor = `rgb(${gold[0]}, ${gold[1]}, ${gold[2]})`;
      });
      clearInterval(timer);
      // Animate after loading
      animateQuizElements();
      
      // Update Previous button visibility
      updatePreviousButtonVisibility();
    }

    // Interpolate gold â†’ red
    function interpolateColor(color1, color2, factor) {
      let result = color1.slice();
      for (let i = 0; i < 3; i++) {
        result[i] = Math.round(result[i] + factor * (color2[i] - color1[i]));
      }
      return `rgb(${result[0]}, ${result[1]}, ${result[2]})`;
    }

    const gold = [255, 215, 0];
    const red = [255, 0, 0];
    const TIME_UP_IMAGE = 'timeup.png';

    // Show TIME UP overlay image and hide the current question image (if present)
    function showTimeUpOverlay() {
      if (!optionsEl) return;

      // Avoid duplicates
      const existingOverlay = optionsEl.querySelector('.timeup-image');
      if (existingOverlay) return;

      const questionImg = optionsEl.querySelector('.quiz-image');
      if (questionImg) {
        questionImg.style.display = 'none';
      }

      const overlay = document.createElement('img');
      overlay.src = TIME_UP_IMAGE;
      overlay.className = 'timeup-image';
      overlay.setAttribute('data-aos', 'zoom-in');
      optionsEl.appendChild(overlay);

      overlay.addEventListener('click', () => {
        overlay.remove();
        if (questionImg) {
          questionImg.style.display = 'block';
        }
      });
    }

    function startTimer() {
      clearInterval(timer);
      timeLeft = 15;
      timeEl.classList.remove('time-up');
      timeEl.innerText = timeLeft;
      timeEl.style.color = `rgb(${gold[0]}, ${gold[1]}, ${gold[2]})`;
      rings.forEach(r => {
        r.style.opacity = 1;
        r.style.borderColor = `rgb(${gold[0]}, ${gold[1]}, ${gold[2]})`;
      });

      function updateTimer() {
        if (timeLeft <= 0) {
          clearInterval(timer);
          timeEl.innerText = "TIME'S UP";
          timeEl.classList.add('time-up');
          rings.forEach(r => r.style.opacity = 0);
          // Show TIME UP image overlay
          showTimeUpOverlay();
          return;
        }

        timeLeft--;
        timeEl.innerText = timeLeft;

        let factor = 1 - timeLeft / totalTime;
        let newColor = interpolateColor(gold, red, factor);

        timeEl.style.color = newColor;
        rings.forEach(r => r.style.borderColor = newColor);
      }

      timer = setInterval(updateTimer, 1000);
      updateTimer();
    }

    function startRound1() {
      currentRound = 1;
      quizData = getRandomQuestions('round1', 12);
      currentQuestion = 0;
      // Update toggle button text
      if (roundToggleBtn) {
        roundToggleBtn.textContent = roundNames[currentRound];
      }
      // Show Round 1 rules container
      endContainer.classList.add("hidden");
      if (roundTransitionBtn) {
        roundTransitionBtn.style.display = 'none';
        roundTransitionBtn.onclick = null;
      }
      if (rulesContainer) {
        rulesContainer.classList.remove("hidden");
      }
      // Refresh score buttons
      setupScores();
    }

    function startRound2() {
      currentRound = 2;
      quizData = getRandomQuestions('round2', 12);
      currentQuestion = 0;
      // Update toggle button text
      if (roundToggleBtn) {
        roundToggleBtn.textContent = roundNames[currentRound];
      }
      // Show Round 2 explanation first
      endContainer.classList.add("hidden");
      if (roundTransitionBtn) {
        roundTransitionBtn.style.display = 'none';
        roundTransitionBtn.onclick = null;
      }
      if (rulesContainer) rulesContainer.classList.add("hidden");
      if (explanation2Container) {
        explanation2Container.classList.remove("hidden");
      }
      // Refresh score buttons
      setupScores();
    }

    function startRound2Begin() {
      if (rules2Container) rules2Container.classList.add("hidden");
      quizContainer.classList.remove("hidden");
      loadQuestion();
      // Refresh score buttons within the quiz as well
      setupScores();
    }

    function startRound3() {
      currentRound = 3;
      quizData = getRandomQuestions('round3', 11);
      currentQuestion = 0;
      // Update toggle button text
      if (roundToggleBtn) {
        roundToggleBtn.textContent = roundNames[currentRound];
      }
      // Show Round 3 explanation first
      endContainer.classList.add("hidden");
      if (roundTransitionBtn) {
        roundTransitionBtn.style.display = 'none';
        roundTransitionBtn.onclick = null;
      }
      if (rulesContainer) rulesContainer.classList.add("hidden");
      if (rules2Container) rules2Container.classList.add("hidden");
      if (explanation3Container) {
        explanation3Container.classList.remove("hidden");
      }
      // Refresh score buttons
      setupScores();
    }

    function startRound3Begin() {
      if (rules3Container) rules3Container.classList.add("hidden");
      quizContainer.classList.remove("hidden");
      loadQuestion();
      // Refresh score buttons within the quiz as well
      setupScores();
    }

    // Round names for display
    const roundNames = {
      1: "Round 1", 
      2: "Round 2",
      3: "Round 3"
    };

    // Toggle between rounds
    function toggleRound() {
      if (currentRound === 1) {
        // Switch to Round 2
        currentRound = 2;
        quizData = getRandomQuestions('round2', 12);
        currentQuestion = 0;
        roundToggleBtn.textContent = roundNames[currentRound];
        loadQuestion();
        setupScores();
      } else if (currentRound === 2) {
        // Switch to Round 3
        currentRound = 3;
        quizData = getRandomQuestions('round3', 11);
        currentQuestion = 0;
        roundToggleBtn.textContent = roundNames[currentRound];
        loadQuestion();
        setupScores();
      } else if (currentRound === 3) {
        // Switch back to Round 1
        currentRound = 1;
        quizData = getRandomQuestions('round1', 12);
        currentQuestion = 0;
        roundToggleBtn.textContent = roundNames[currentRound];
        loadQuestion();
        setupScores();
      }
      
      // Reset timer display
      timeLeft = 15;
      timeEl.classList.remove('time-up');
      timeEl.innerText = timeLeft;
      timeEl.style.color = `rgb(${gold[0]}, ${gold[1]}, ${gold[2]})`;
      rings.forEach(r => {
        r.style.opacity = 1;
        r.style.borderColor = `rgb(${gold[0]}, ${gold[1]}, ${gold[2]})`;
      });
      clearInterval(timer);
      
      // Animate after loading
      animateQuizElements();
      
      // Update Previous button visibility
      updatePreviousButtonVisibility();
    }


    // Function to populate final results with top 3 teams
    function populateFinalResults() {
      const sortedTeams = [...teams].sort((a, b) => b.score - a.score);
      
      // Get top 3 teams
      const winner = sortedTeams[0];
      const runnerUp = sortedTeams[1];
      const third = sortedTeams[2];
      
      // Populate winner
      if (winner) {
        document.getElementById('winner-name').textContent = winner.name;
        document.getElementById('winner-score').textContent = winner.score;
      } else {
        document.getElementById('winner-name').textContent = 'No Winner';
        document.getElementById('winner-score').textContent = '0';
      }
      
      // Populate runner-up
      if (runnerUp) {
        document.getElementById('runnerup-name').textContent = runnerUp.name;
        document.getElementById('runnerup-score').textContent = runnerUp.score;
      } else {
        document.getElementById('runnerup-name').textContent = 'No Runner-Up';
        document.getElementById('runnerup-score').textContent = '0';
      }
      
      // Populate third place
      if (third) {
        document.getElementById('third-name').textContent = third.name;
        document.getElementById('third-score').textContent = third.score;
      } else {
        document.getElementById('third-name').textContent = 'No Third Place';
        document.getElementById('third-score').textContent = '0';
      }
    }

    // First load is handled by button clicks now
    // initializeScores();
    // loadQuestion();
    loadTeamsFromStorage();

    // (hover handlers removed)

    // Click-to-zoom toggle for quiz and answer images (controls remain visible)
    document.addEventListener('click', function(e) {
      const target = e.target;
      if (target.classList && (target.classList.contains('quiz-image') || target.classList.contains('answer-image')) ) {
        // Toggle zoomed state
        target.classList.toggle('zoomed');

        // Keep quiz controls visible and interactive; only fade side container
        const sideContainer = document.querySelector('.side-container');
        const anyZoomed = document.querySelector('.quiz-image.zoomed, .answer-image.zoomed');

        if (sideContainer) {
          sideContainer.style.opacity = anyZoomed ? '0' : '1';
          sideContainer.style.pointerEvents = anyZoomed ? 'none' : 'auto';
        }
      }
    });